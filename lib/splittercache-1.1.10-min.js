"use strict";if("undefined"==typeof _||!_)throw"ERROR: Lo-dash-underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var a=function(a){var b,c=0;if(!_.isObject(a))throw"taskdef must be an object";if(!_.isString(a.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(a.location)){if(!_.isString(a.location))throw"taskDef must contain a 'location' property of either an array or a string type";b=a.location,a.location=[],a.location.push(b)}if(!_.isArray(a.parameter)){if(!_.isString(a.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";b=a.parameter,a.parameter=[],a.parameter.push(b)}if(!_.isNumber(a.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(a.resolution>.5))throw"taskDef.resolution must be a positive integer";if(a.resolution=Math.round(a.resolution),!_.isNumber(a.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(a.pointCount)){if(!(a.pointCount>0))throw"taskDef.pointCount must be greater than zero";a.end=a.start+(a.pointCount-1)*a.resolution}else{if(!_.isNumber(a.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(a.end<a.start)throw"'end' must be greater than or equal to 'start'";c=(a.end-a.start)%a.resolution,0!==c&&(a.end=a.end+(a.resolution-c)),a.pointCount=(a.end-a.start)/a.resolution+1}},b=function(a,b){var c=0;if(_.isArray(a)&&_.isArray(b)){if(a.length===b.length){for(c=0;c<a.length;c++)if(-1===_.indexOf(b,a[c]))return!1;return!0}return!1}return void 0===a||null===a||void 0===b||null===b?!1:a===b},c=function(){var b=0,c=function(c){function d(){f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=0,n=!1,o=!1,p=!1,q=[]}var e=null,f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=0,n=!1,o=!1,p=!1,q=[],r=0,s=c,t=this;this.getId=function(){return e},this.getTaskDef=function(){return i},this.getStart=function(){return null!==i?i.start:void 0},this.getEnd=function(){return null!==i?i.end:void 0},this.getPointCount=function(){return null!==i?i.pointCount:void 0},this.getResolution=function(){return null!==i?i.resolution:void 0},this.getService=function(){return null!==i?i.service:void 0},this.getLocation=function(){return null!==i?i.location:void 0},this.getParameter=function(){return null!==i?i.parameter:void 0},this.getDataSize=function(){return null!==i?i.pointCount*i.parameter.length*i.location.length:0},this.pin=function(){return n?null:(m++,s&&s("blockPinned",t),m)},this.unpin=function(){return m>0&&(m--,s&&s("blockUnpinned",t)),m},this.isPinned=function(){return m>0},this.getPinCount=function(){return m},this.getRequestId=function(){return r},this.isWaitingRecycling=function(){return n},this.isWaitingMerging=function(){return o},this.isFetched=function(){return l},this.setFetched=function(a){l=a===!0?!0:!1},this.isFetching=function(){return k},this.setFetching=function(a){k=a===!0?!0:!1},this.increaseNotUsed=function(){j++,s&&s("blockAged",t)},this.getNotUsedSince=function(){return j},this.fetchFailed=function(){return null!==f},this.markForRecycling=function(){n=!0,s&&s("blockEvicted",t)},this.markForMerging=function(a){a===!0?(o=!0,s&&s("blockMarkedForMerge",t)):(o=!1,s&&s("blockMergeCancelled",t))},this.setData=function(a){h=a},this.getFetcher=function(){return g},this.recycle=function(){d(),s&&s("blockRecycled",t)},this.prepare=function(b,c){if(!_.isFunction(c))throw"fetcher must be a function";a(b),d(),i=b,g=c,p=!0,r++,s&&s("blockPrepared",t)},this.getDataAsync=function(a){var b=this;if(!p)throw"Cannot getData in unprepared state, call prepare first";j=0,l?_.isFunction(a)&&(_.defer(function(b,c){s&&s("blockCacheFetchFinished",t),a(b,c)},f,h),s&&s("blockCacheFetchStarted",t)):(void 0!==a&&_.isFunction(a)&&q.push(a),k||(k=!0,g(i,function(a,c){var d=b.getRequestId();a&&(f=a),h=c,l=!0,0===q.length?k=!1:async.whilst(function(){var a=b.getRequestId();return d===a&&q.length>0},function(a){try{var c=q.pop();c.call(b,f,h)}catch(d){"undefined"!=typeof console&&console&&console.error("Error in block finished callback:"+d.message)}finally{a(),k=!1}},function(){}),s&&s("blockProviderFetchFinished",t)}),s&&s("blockProviderFetchStarted",t)))},e="id#"+b++,s&&s("blockCreated",t)};return c}(),d=0,e=0,f=function(f){function g(a,b){void 0!==O[a]&&_.each(O[a],function(a){try{a.call(N,b)}catch(c){}})}function h(a,b){var c=null;if(void 0===O[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(O),function(a,b,c){return c>0&&(a+=", "),a+=b});if(!_.isFunction(b))throw"Event listener callback is not a function";return c="id"+d++,O[a][c]=b,c}function i(a,b){if(void 0===O[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(O),function(a,b,c){c>0&&(a+=", "),a+=b});void 0!==O[a][b]&&delete O[a][b]}function j(a){async.each(a,function(a,b){a.markForRecycling(),b()},function(a){a&&"undefined"!=typeof console&&console&&console.error(a)})}function k(a,b,c){var d=null,e={},f=[];a.pin()>0&&b.pin()>0?(a.markForMerging(!0),b.markForMerging(!0),d=n(),e=_.clone(a.getTaskDef()),e.end=b.getEnd(),e.pointCount=a.getPointCount()+b.getPointCount(),d.prepare(e,a.getFetcher()),d.setFetching(!0),g("blockCacheFetchStarted",d),async.parallel({data1:function(b){a.getDataAsync(function(c,d){c?("undefined"!=typeof console&&console&&console.log("Warning: getDataAsync from merged block1 returned error:'"+c+"'"),b(c)):t(f,d,e.location,e.parameter,0,0,a.getPointCount(),b)})},data2:function(c){b.getDataAsync(function(d,g){d?("undefined"!=typeof console&&console&&console.log("Warning: getDataAsync from merged block2 returned error:'"+d+"'"),c(d)):t(f,g,e.location,e.parameter,a.getPointCount(),0,b.getPointCount(),c)})}},function(e){a.unpin(),b.unpin(),e?(d.reset(),a.markForMerging(!1),b.markForMerging(!1),c(e),g("blockCacheFetchFinished",null)):(a.markForRecycling(),b.markForRecycling(),d.setData(f),d.setFetching(!1),d.setFetched(!0),c(null,d),g("blockCacheFetchFinished",d))})):_.defer(function(){c(new Error("One or both blocks already marked for recycling"))})}function l(a,b){return a.getResolution()===b.getResolution()&&b.getStart()===a.getEnd()+a.getResolution()?!0:!1}function m(a,b){return!a.fetchFailed()&&!b.fetchFailed()&&!a.isWaitingMerging()&&!b.isWaitingMerging()&&(a.getPointCount()<F||b.getPointCount()<F)&&l(a,b)&&a.getPointCount()+b.getPointCount()<E?!0:!1}function n(){var a;return a=y.length>0?y.pop():new c(g)}function o(a,b,c,d){var e=!1;return a===c&&b===d?e=!0:d>=a&&b>c&&(e=!0),e}function p(a,b,c,d,e){var f=null;return(null===a||a<b-e.resolution)&&b>c&&(f=b>=d?null===a?s(e,c,d):s(e,Math.max(a,c),d):null===a?s(e,c,b-e.resolution):s(e,Math.max(a+e.resolution,c),b-e.resolution)),f}function q(a){a.isPinned()?async.whilst(function(){return a.isPinned()},function(a){setTimeout(a,500)},function(){a.recycle(),y.push(a)}):(a.recycle(),y.push(a))}function r(a){var c=[],d=a.start,e=a.end,f=Math.ceil(C*a.pointCount),h=Math.ceil(D*a.pointCount),i=d-f*a.resolution,l=e+h*a.resolution,n=[],r=[],t=-1,u=null,v=null,w=function(a){return a.getStart()};for(K=0;A.length>0;)u=A.shift(),t=_.sortedIndex(z,u,w),z.splice(t,0,u);return z.length>0&&_.each(z,function(d,e){var f=!1,g=null,h=null,j=null,t=d.getStart(),u=d.getEnd();if(d.isWaitingRecycling())return void q(d);a.service===d.getService()&&b(a.location,d.getLocation())&&b(a.parameter,d.getParameter())?(null!==v&&(j=v.getEnd()),g=p(j,t,i,l,a),null!==g&&g.length>0&&(Array.prototype.push.apply(r,g),async.reduce(g,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b}),Array.prototype.push.apply(c,g)),f=o(t,u,i,l),f?d.pin()>0?(c.push(d),L+=d.getDataSize()):"undefined"!=typeof console&&console&&console.log("Unable to pin a block, it's already marked for recycling (this should not happen)"):d.increaseNotUsed(),r.push(d),null!==v&&m(v,d)&&k(v,d,function(a,b){a?"undefined"!=typeof console&&console&&console.error(a):A.push(b)}),v=d):(d.increaseNotUsed(),r.push(d)),e===z.length-1&&null!==v&&v.getEnd()+a.resolution<l&&(h=s(a,Math.max(u+a.resolution,i),l),Array.prototype.push.apply(r,h),async.reduce(h,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b}),Array.prototype.push.apply(c,h));var w=_.sortedIndex(n,d,function(a){return a.getNotUsedSince()});n.splice(w,0,d),K+=d.getDataSize()}),0===c.length&&(c=s(a,i,l),Array.prototype.push.apply(r,c),async.reduce(c,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b})),z=[],z=r,r=[],async.whilst(function(){return 1.01*K>G},function(){var a=1.01*K-G;g("evictStarted",{inCache:K,toEvict:a});for(var b=[],c=null,d=0;a>d&&n.length>0;)c=n.pop(),void 0!==c&&(d+=c.getDataSize(),b.push(c));b.length>0&&(j(b),K-=d,g("evictFinished",{inCache:K,evicted:d}))},function(){}),c}function s(a,b,c){var d,e=[],f=Math.round((c-b)/a.resolution)+1,g=Math.ceil(f/E),h=0,i=null;for(h=0;g>h;h++)i=n(),d=_.clone(a),d.start=b+h*a.resolution*E,d.pointCount=Math.min(E,f-h*E),d.end=d.start+(d.pointCount-1)*a.resolution,i.prepare(d,w(a.service)),i.pin()>0?e.push(i):"undefined"!=typeof console&&console&&console.error("Strange, unable to pin block!");return e}function t(a,b,c,d,e,f,g,h){var i=_.isObject(b),j=0,k=0,l=0;async.each(c,function(c,h){void 0===a[c]&&(a[c]={}),async.each(d,function(d,h){var m=!1;if(void 0===a[c][d]&&(a[c][d]=[]),i&&(_.isObject(b[c])&&_.isArray(b[c][d])?b[c][d].length<f+g&&(m=!0,"undefined"!=typeof console&&console&&console.error("Trying to fill segment with only "+b[c][d].length+" values for location "+c+" and parameter "+d+" when "+(f+g)+" would be needed. Filling the whole segment with '"+I+"'")):m=!0),m)for(j=e,l=e+g;l>j;)a[c][d][j++]=I;else if(i)for(j=e,k=f,l=e+g;l>j;)a[c][d][j++]=b[c][d][k++];else for(j=e,l=e+g;l>j;)a[c][d][j++]=b;h()},function(){h()})},function(b){h(b,a)})}function u(a,b,c){var d=_.clone(a);if(!_.isFunction(b))throw"finishCallback must be a function";if(null===w(d.service))throw"No data fetcher set for service '"+d.service+"', unable to provide data";void 0!==B[d.service]&&(B[d.service].resolution!==d.resolution||Math.abs(B[d.service].start-d.start)%d.resolution!==0)&&x(d.service),B[d.service]={start:d.start,resolution:d.resolution},P.push(d,function(a,e){v(e,d,b,c)})}function v(a,b,c,d){var e=null,f=!1,h={};_.isFunction(d)&&(f=!0),g("fetchStarted",b),h.steps=_.range(b.start,b.end+b.resolution,b.resolution),h.data={},async.each(a,function(a,c){var g=a.getTaskDef(),i=0/0,j=0/0,k=0/0,l=0/0,m=0/0,n=0/0;if(!o(g.start,g.end,b.start,b.end))return a.getDataAsync(function(){a.unpin()}),void c();if(g.start<b.start?(i=b.start,m=Math.round((b.start-g.start)/b.resolution)):(i=g.start,m=0),k=_.indexOf(h.steps,i,!0),-1===k)throw a.getId()+":something wrong with indexing, start index for cache block not found in the combined results!";g.end>b.end?(j=b.end,l=h.steps.length-1):(j=g.end,l=_.indexOf(h.steps,g.end,!0)),n=l-k+1,a.getDataAsync(function(b,l){var o=l;b&&(null===e&&(e=[]),e.push({start:g.start,end:g.end,error:b}),(H||!l)&&(o=I),a.markForRecycling()),t(h.data,o,g.location,g.parameter,k,m,n,function(){f&&d(b,i,j),a.unpin(),c()})})},function(){c(e,h),g("fetchFinished",b)})}function w(a){return void 0!==J[a]?(J[a].nextIndex=(J[a].nextIndex+1)%J[a].providers.length,J[a].providers[J[a].nextIndex].cb):null}function x(a){_.each(z,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),_.each(A,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),g("cacheCleared",a)}var y=[],z=[],A=[],B=[],C=.5,D=1,E=500,F=20,G=5e4,H=!0,I=0/0,J={},K=0,L=0,M=0,N=this,O={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},blockMarkedForMerge:{},blockMergeCancelled:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}},P=async.queue(function(a,b){b(null,r(a))},1);this.addDataProvider=function(a,b){var c={};if(!_.isFunction(b))throw"Fetcher must be a function";return void 0===J[a]&&(J[a]={nextIndex:0,providers:[]}),c.id="id#"+e++,c.cb=b,J[a].providers.push(c),g("dataProviderAdded",{service:a,providerId:c.id}),c.id},this.removeDataProvider=function(a,b){var c=0,d=!1;void 0!==J[a]&&(c=J[a].providers.length,J[a].providers=_.reject(J[a].providers,function(a){return a.id===b}),0===J[a].providers.length?(delete J.service,d=!0):c!==J[a].providers.length&&(d=!0),d&&g("dataProviderRemoved",{service:a,providerId:b}))},this.clearCache=function(){x(),B=[],L=0,M=0},this.fetch=function(b,c,d){a(b),u(b,c,d)},this.getCachedItemCount=function(){return K},this.getFillingDegree=function(){return K/G},this.getHitRatio=function(){return L/(L+M)},this.addListener=function(a,b){return h(a,b)},this.removeListener=function(a,b){return i(a,b)},void 0!==f.sideFetchBeforeFactor&&_.isNumber(f.sideFetchBeforeFactor)&&f.sideFetchBeforeFactor>=0&&(C=f.sideFetchBeforeFactor),void 0!==f.sideFetchAfterFactor&&_.isNumber(f.sideFetchAfterFactor)&&f.sideFetchAfterFactor>=0&&(D=f.sideFetchAfterFactor),void 0!==f.maxBlockDataPoints&&_.isNumber(f.maxBlockDataPoints)&&f.maxBlockDataPoints>0&&(E=f.maxBlockDataPoints),void 0!==f.minBlockDataPoints&&_.isNumber(f.minBlockDataPoints)&&(F=f.minBlockDataPoints>0&&f.minBlockDataPoints<E?f.minBlockDataPoints:0),F>E&&(F=E),void 0!==f.maxCacheDataSize&&_.isNumber(f.maxCacheDataSize)&&f.maxCacheDataSize>0&&(G=f.maxCacheDataSize),void 0!==f.strictErrorHandling&&f.strictErrorHandling===!1&&(H=!1),void 0!==f.errorFillValue&&(I=f.errorFillValue)};return f}();