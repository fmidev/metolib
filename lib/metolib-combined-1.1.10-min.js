"use strict";if("undefined"==typeof _||!_)throw"ERROR: Lodash is required for fi.fmi.metoclient.metolib.Utils!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.Utils=function(){function a(a){var b=0;if(a)if(_.isFunction(Object.keys))b=Object.keys(a).length;else for(var c in a)a.hasOwnProperty(c)&&++b;return b}return function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d--;)a=c[d],e[a]||(e[a]=b)}(),function(){if(!jQuery.browser){var a,b;jQuery.uaMatch=function(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},a=jQuery.uaMatch(navigator.userAgent),b={},a.browser&&(b[a.browser]=!0,b.version=a.version),b.chrome?b.webkit=!0:b.webkit&&(b.safari=!0),jQuery.browser=b}}(),function(){window.XDomainRequest&&jQuery.ajaxTransport(function(a){if(a.crossDomain&&a.async){a.timeout&&(a.xdrTimeout=a.timeout,delete a.timeout);var b;return{send:function(c,d){function e(a,c,e,f){b.onload=b.onerror=b.ontimeout=jQuery.noop,b=void 0,d(a,c,e,f)}b=new XDomainRequest,b.onload=function(){e(200,"OK",{text:b.responseText},"Content-Type: "+b.contentType)},b.onerror=function(){e(404,"Not Found")},b.onprogress=function(){},b.ontimeout=function(){e(0,"timeout")},b.timeout=a.xdrTimeout||0,b.open(a.type,a.url),b.send(a.hasContent&&a.data||null)},abort:function(){b&&(b.onerror=jQuery.noop,b.abort())}}}})}(),function(){Date.prototype.toISOString||(Date.prototype.toJSON||(Date.prototype.toJSON=function(){var a=function(a){return 10>a?"0"+a:a};return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"}),Date.prototype.toISOString=Date.prototype.toJSON)}(),{objectLength:function(b){return a(b)},encodeUriComponent:function(a){return a?encodeURIComponent(a):a},encodeUri:function(a){return a?encodeURI(a):a},sortStringArray:function(a,b){var c;return a&&_.isArray(a)&&(b?(c=[],_.each(a,function(a){c.push(a)})):c=a,c.sort(function(a,b){var c=0,d=a.toLowerCase(),e=b.toLowerCase();return e>d?c=-1:d>e&&(c=1),c})),c}}}(),"undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsRequestParser!";if("undefined"==typeof _||!_)throw"ERROR: Lodash is required for fi.fmi.metoclient.metolib.WfsRequestParser!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},"undefined"==typeof fi.fmi.metoclient.metolib.Utils||!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsRequestParser!";if(fi.fmi.metoclient.metolib.WfsRequestParser=function(){function a(){return{label:"",unit:"",phenomenon:"",statisticalFunction:"",statisticalPeriod:""}}function b(a,b){var c=a&&b&&a.hasOwnProperty(b);if(!c&&a&&b){var d=b.toLowerCase();for(var e in a)if(a.hasOwnProperty(e)&&e.toLowerCase()===d){a[b+""]=a[e],delete a[e],c=!0;break}}return c}function c(a,b,c){try{var e={info:{begin:void 0,end:void 0},locations:[],positions:{},gmlcovPositions:{srsDimension:void 0,timeIndex:void 0,contents:[]},data:[],parameters:[],propertiesContainer:{urls:[],properties:{}}},g=0,h=function(){++g},i=function(){g>0&&--g,0===g&&(g=-1,eb(c,d(e,b),b))};f(a,e,h,i,b),0===g&&i()}catch(j){"undefined"!=typeof console&&console&&console.error("ERROR: Error during synchronous data parsing flow!"),g=-1;var k={};k[ob.KEY_ERROR_TEXT]=j.toString(),b.push(k),eb(c,void 0,b)}}function d(c,d){var f={info:c.info,parameters:c.parameters,properties:c.propertiesContainer.properties,locations:[]};try{var g=c.gmlcovPositions.srsDimension||0,h=c.gmlcovPositions.contents||[],i=c.parameters.length;if(g>0&&c.data.length===i*(h.length/g)&&c.locations.length===fi.fmi.metoclient.metolib.Utils.objectLength(c.positions)){for(var j=0;j<c.locations.length;++j){var k=c.locations[j],l=k.pointRef,m="ERROR: Location and position data do not match!";if(!l)throw m;var n=c.positions[l];if(!n)throw m;f.locations.push({info:{id:k.id||"",geoid:k.geoid||"",wmo:k.wmo||"",fmisid:k.fmisid||"",name:k.name||n.name||"",region:k.region||"",country:k.country||"",timezone:k.timezone||"",position:n.position||""}})}for(var o=0;o<h.length;o+=g){for(var p={time:parseInt(h[o+g-1],10)*ob.EPOCH_TO_MS,values:{}},q=0;q<f.parameters.length;++q){var r=f.parameters[q];r&&(p.values[r]=parseFloat(c.data[o/g*i+q]),b(f.properties,r)&&f.properties[r]||("undefined"!=typeof console&&console&&console.error("ERROR: Server has not provided properties for request parameter!"),f.properties[r]=a()))}for(var s=0;s<f.locations.length;++s){for(var t=0,u=f.locations[s],v=0;v<u.info.position.length&&u.info.position[v]===h[o+v];++v)++t;if(u.info.position&&t===u.info.position.length){u.timeValuePairs||(u.timeValuePairs=[]),u.timeValuePairs.push(p);break}}}e(f.locations)}else if(0!==c.data.length||0!==h.length)throw"ERROR: Parsed lists do not match!"}catch(w){"undefined"!=typeof console&&console&&console.error("ERROR: Could not finalize data!"),f=void 0;var x={};x[ob.KEY_ERROR_TEXT]=w.toString(),d.push(x)}return f}function e(a){if(a&&a.length)for(var b=0;b<a.length-1;++b){for(var c=a[b],d=[],e=b+1;e<a.length;++e){var f=a[e];if(c.info.position.length===f.info.position.length){for(var g=c.info.position.length,h=!0,i=0;g>i;++i)if(c.info.position[i]!==f.info.position[i]){h=!1;break}h&&d.push(f)}}if(d.length)for(var j=c.timeValuePairs,k=j.length/(d.length+1),l=0;l<d.length;++l)d[l].timeValuePairs=j.splice(k,k)}}function f(a,b,c,d,e){a&&(S(a,e)||jQuery(a).children(ob.XML_WFS_FEATURE_COLLECTION).each(function(){g(this,b,c,d,e)}))}function g(a,b,c,d,e){jQuery(a).children(ob.XML_WFS_MEMBER).each(function(){h(this,b,c,d,e),i(this,b,c,d,e)})}function h(a,b,c,d,e){jQuery(a).children(ob.XML_OMSO_POINT_TIME_SERIES_OBSERVATION).each(function(){j(this,b.info,c,d,e),n(this,b.propertiesContainer,c,d,e),o(this,b,c,d,e),H(this,b,c,d,e)})}function i(a,b,c,d,e){jQuery(a).children(ob.XML_OMSO_GRID_SERIES_OBSERVATION).each(function(){j(this,b.info,c,d,e),n(this,b.propertiesContainer,c,d,e),o(this,b,c,d,e),H(this,b,c,d,e)})}function j(a,b,c,d,e){jQuery(a).children(ob.XML_OM_PHENOMENON_TIME).each(function(){k(this,b,c,d,e)})}function k(a,b,c,d,e){jQuery(a).children(ob.XML_GML_TIME_PERIOD).each(function(){l(this,b,c,d,e),m(this,b,c,d,e)})}function l(a,b){jQuery(a).children(ob.XML_GML_BEGIN_POSITION).each(function(){var a=jQuery.trim(jQuery(this).text());a&&(b.begin=new Date(a))})}function m(a,b){jQuery(a).children(ob.XML_GML_END_POSITION).each(function(){var a=jQuery.trim(jQuery(this).text());a&&(b.end=new Date(a))})}function n(a,b,c,d,e){jQuery(a).children(ob.XML_OM_OBSERVED_PROPERTY).each(function(){var a=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_XLINK_HREF));a&&!_.contains(b.urls,a)&&(b.urls.push(a),fb(a,e,function(a){S(a,e)||a&&(V(a,b.properties,c,d,e),X(a,b.properties,c,d,e)),d()}),c())})}function o(a,b,c,d,e){jQuery(a).children(ob.XML_OM_FEATURE_OF_INTEREST).each(function(){p(this,b,c,d,e)})}function p(a,b,c,d,e){jQuery(a).children(ob.XML_SAMS_SF_SPATIAL_SAMPLING_FEATURE).each(function(){q(this,b.locations,c,d,e),A(this,b.positions,c,d,e)})}function q(a,b,c,d,e){jQuery(a).children(ob.XML_SAM_SAMPLED_FEATURE).each(function(){r(this,b,c,d,e)})}function r(a,b,c,d,e){jQuery(a).children(ob.XML_TARGET_LOCATION_COLLECTION).each(function(){s(this,b,c,d,e)})}function s(a,b,c,d,e){jQuery(a).children(ob.XML_TARGET_MEMBER).each(function(){t(this,b,c,d,e)})}function t(a,b,c,d,e){jQuery(a).children(ob.XML_TARGET_LOCATION).each(function(){var a={};u(this,a,c,d,e),v(this,a,c,d,e),w(this,a,c,d,e),x(this,a,c,d,e),y(this,a,c,d,e),z(this,a,c,d,e),b.push(a)})}function u(a,b){jQuery(a).children(ob.XML_GML_IDENTIFIER).each(function(){b.id=jQuery.trim(jQuery(this).text());var a=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_CODE_SPACE));ob.XML_ATTR_CODE_SPACE_FMISID===a&&(b.fmisid=jQuery.trim(jQuery(this).text()))})}function v(a,b){jQuery(a).children(ob.XML_GML_NAME).each(function(){var a=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_CODE_SPACE));ob.XML_ATTR_CODE_SPACE_NAME===a?b.name=jQuery.trim(jQuery(this).text()):ob.XML_ATTR_CODE_SPACE_WMO===a?b.wmo=jQuery.trim(jQuery(this).text()):ob.XML_ATTR_CODE_SPACE_GEOID===a&&(b.geoid=jQuery.trim(jQuery(this).text()))})}function w(a,b){jQuery(a).children(ob.XML_TARGET_REGION).each(function(){b.region=jQuery.trim(jQuery(this).text())})}function x(a,b){jQuery(a).children(ob.XML_TARGET_COUNTRY).each(function(){b.country=jQuery.trim(jQuery(this).text())})}function y(a,b){jQuery(a).children(ob.XML_TARGET_TIMEZONE).each(function(){b.timezone=jQuery.trim(jQuery(this).text())})}function z(a,b){jQuery(a).children(ob.XML_TARGET_REPRESENTATIVE_POINT).each(function(){b.pointRef=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_XLINK_HREF)),b.pointRef&&b.pointRef.charAt(0)===ob.XML_REF_PREFIX&&(b.pointRef=b.pointRef.slice(1))})}function A(a,b,c,d,e){jQuery(a).children(ob.XML_SAMS_SHAPE).each(function(){C(this,b,c,d,e)})}function B(a,b,c,d,e){jQuery(a).children(ob.XML_GML_POINT).each(function(){var a=this,f=jQuery.trim(jQuery(a).attr(ob.XML_ATTR_GML_ID));if(f){b[f]||(b[f]={name:"",position:[]});var g=b[f];F(this,g,c,d,e),G(this,g.position,c,d,e)}})}function C(a,b,c,d,e){jQuery(a).children(ob.XML_GML_MULTI_POINT).each(function(){D(this,b,c,d,e),E(this,b,c,d,e)})}function D(a,b,c,d,e){jQuery(a).children(ob.XML_GML_POINT_MEMBER).each(function(){B(this,b,c,d,e)})}function E(a,b,c,d,e){jQuery(a).children(ob.XML_GML_POINT_MEMBERS).each(function(){B(this,b,c,d,e)})}function F(a,b){jQuery(a).children(ob.XML_GML_NAME).each(function(){b.name=jQuery.trim(jQuery(this).text())})}function G(a,b){jQuery(a).children(ob.XML_GML_POS).each(function(){var a=jQuery.trim(jQuery(this).text());a&&b.push.apply(b,a.split(ob.REGEX_WHITE_SPACE))})}function H(a,b,c,d,e){jQuery(a).children(ob.XML_OM_RESULT).each(function(){I(this,b,c,d,e)})}function I(a,b,c,d,e){jQuery(a).children(ob.XML_GMLCOV_MULTI_POINT_COVERAGE).each(function(){M(this,b,c,d,e),P(this,b,c,d,e),J(this,b,c,d,e)})}function J(a,b,c,d,e){jQuery(a).children(ob.XML_GMLCOV_RANGE_TYPE).each(function(){K(this,b,c,d,e)})}function K(a,b,c,d,e){jQuery(a).children(ob.XML_SWE_DATA_RECORD).each(function(){L(this,b.parameters,c,d,e)})}function L(a,b){jQuery(a).children(ob.XML_SWE_FIELD).each(function(){var a=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_NAME));a&&!_.contains(b,a)&&b.push(a)})}function M(a,b,c,d,e){jQuery(a).children(ob.XML_GML_DOMAIN_SET).each(function(){N(this,b,c,d,e)})}function N(a,b,c,d,e){jQuery(a).children(ob.XML_GMLCOV_SIMPLE_MULTI_POINT).each(function(){var a=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_SRS_DIMENSION));a&&(a=parseInt(a,10),a>0&&(b.gmlcovPositions.srsDimension=a,b.gmlcovPositions.timeIndex=a-1)),O(this,b.gmlcovPositions.contents,c,d,e)})}function O(a,b){jQuery(a).children(ob.XML_GMLCOV_POSITIONS).each(function(){var a=jQuery.trim(jQuery(this).text());a&&b.push.apply(b,a.split(ob.REGEX_WHITE_SPACE))})}function P(a,b,c,d,e){jQuery(a).children(ob.XML_GML_RANGE_SET).each(function(){Q(this,b,c,d,e)})}function Q(a,b,c,d,e){jQuery(a).children(ob.XML_GML_DATA_BLOCK).each(function(){R(this,b.data,c,d,e)})}function R(a,b){jQuery(a).children(ob.XML_GML_DOUBLE_OR_NIL_REASON_TUPLE_LIST).each(function(){var a=jQuery.trim(jQuery(this).text());a&&b.push.apply(b,a.split(ob.REGEX_WHITE_SPACE))})}function S(a,b){var c=!1;try{a&&jQuery(a).children(ob.XML_EXCEPTION_REPORT).each(function(){c=!0;var a={};b.push(a),T(this,a)})}catch(d){"undefined"!=typeof console&&console&&console.error("ERROR: Error while parsing exception data!");var e={};e[ob.KEY_ERROR_TEXT]=d.toString(),b.push(e)}return c}function T(a,b){jQuery(a).children(ob.XML_EXCEPTION).each(function(){b[ob.KEY_ERROR_CODE]=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_EXCEPTION_CODE)),U(this,b)})}function U(a,b){jQuery(a).children(ob.XML_EXCEPTION_TEXT).each(function(){b[ob.KEY_ERROR_TEXT]=jQuery.trim(jQuery(this).text())})}function V(a,b,c,d,e){jQuery(a).children(ob.XML_COMPOSITE_OBSERVABLE_PROPERTY).each(function(){W(this,b,c,d,e)})}function W(a,b,c,d,e){jQuery(a).children(ob.XML_COMPONENT).each(function(){X(this,b,c,d,e)})}function X(b,c,d,e,f){jQuery(b).children(ob.XML_OBSERVABLE_PROPERTY).each(function(){var b=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_GML_ID));if(b){var g=a();Y(this,g,d,e,f),Z(this,g,d,e,f),$(this,g,d,e,f),ab(this,g,d,e,f),c[b]=g}})}function Y(a,b){jQuery(a).children(ob.XML_LABEL).each(function(){b.label=jQuery.trim(jQuery(this).text())})}function Z(a,b){jQuery(a).children(ob.XML_BASE_PHENOMENON).each(function(){b.phenomenon=jQuery.trim(jQuery(this).text())})}function $(a,b){jQuery(a).children(ob.XML_UOM).each(function(){b.unit=jQuery.trim(jQuery(this).attr(ob.XML_ATTR_UOM))})}function ab(a,b,c,d,e){jQuery(a).children(ob.XML_STATISTICAL_MEASURE).each(function(){bb(this,b,c,d,e)})}function bb(a,b,c,d,e){jQuery(a).children(ob.XML_STATISTICAL_MEASURE_INNER).each(function(){cb(this,b,c,d,e),db(this,b,c,d,e)})}function cb(a,b){jQuery(a).children(ob.XML_STATISTICAL_FUNCTION).each(function(){b.statisticalFunction=jQuery.trim(jQuery(this).text())})}function db(a,b){jQuery(a).children(ob.XML_AGGREGATION_TIME_PERIOD).each(function(){b.statisticalPeriod=jQuery.trim(jQuery(this).text())})}function eb(a,b,c){try{a&&a(b,c)}catch(d){"undefined"!=typeof console&&console&&console.error("ERROR: Callback function error!")}}function fb(a,b,c){setTimeout(function(){jQuery.ajax({type:ob.HTTP_METHOD,url:a,dataType:ob.DATA_TYPE,success:function(a){eb(c,a,b)},error:function(a,d,e){var f={};f[ob.KEY_ERROR_CODE]=a.status,f[ob.KEY_ERROR_TEXT]=e||d,b.push(f),eb(c,void 0,b)}})},0)}function gb(a,b){var d=[];fb(a,d,function(a,d){c(a,d,b)})}function hb(a,b,c){if(a&&a.parameters&&b&&c)for(var d=0;d<a.parameters.length;++d){var e=a.parameters[d];if(e){for(var f={property:a.properties[e],timeValuePairs:[]},g=0;g<b.length;++g){var h=b[g];f.timeValuePairs.push({time:h.time,value:h.values[e]})}c[e]=f}}}function ib(a,b,c){var d;try{if(b&&b.parameters&&b.properties&&(d={info:b.info,properties:b.properties,locations:[]},b.locations&&b.locations.length>0))for(var e=b.locations,f=0;f<e.length;++f){var g=e[f],h={info:g.info,data:{}};hb(b,g.timeValuePairs,h.data),d.locations.push(h)}}catch(i){var j="ERROR: Could not finalize data!";"undefined"!=typeof console&&console&&console.error(j),d=void 0;var k={};k[ob.KEY_ERROR_TEXT]=i.toString(),c.push(k)}a(d,c)}function jb(a){var b="";if(a){for(var c in a)a.hasOwnProperty(c)&&(b+=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(c),b+=ob.URL_QUERY_FIELD_VALUE_DELIMITER,b+=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(a[c]||""));b&&(b=ob.URL_QUERY_PREFIX_AND+b)}return b}function kb(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){d instanceof Date||isNaN(d)||(d=new Date(d)),e instanceof Date||isNaN(e)||(e=new Date(e)),c&&_.isArray(c)&&(c=c.join()),(void 0===f||null===f)&&g&&g>0&&d instanceof Date&&e instanceof Date&&(f=Math.round((e.getTime()-d.getTime())/g));var q=a&&_.isString(a),r=b&&_.isString(b),s=c&&_.isString(c),t=d instanceof Date&&e instanceof Date&&d.getTime()<=e.getTime()&&(!f||_.isNumber(f)),u=_.isNumber(i)||i&&_.isString(i)||_.isArray(i)&&i.length,v=_.isNumber(j)||j&&_.isString(j)||_.isArray(j)&&j.length,w=_.isNumber(k)||k&&_.isString(k)||_.isArray(k)&&k.length,x=l&&_.isString(l)||_.isArray(l)&&l.length,y=m&&_.isString(m),z=u||v||w||x||y,A=!n||_.isString(n);if(!(q&&r&&s&&t&&z&&A)){var B="ERROR: Wrong or missing information for the request!";throw"undefined"!=typeof console&&console&&console.error(B),B}h||(d.setTime(lb(f,d).getTime()),e.setTime(mb(f,e,d).getTime()));var C=/\.\d+/;d=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(d.toISOString()).split(C).join(""),e=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(e.toISOString()).split(C).join("");var D="",E=Math.floor(f/ob.MIN_TO_MS);E&&E>0&&(D=ob.REQUEST_TIMESTEP+E),c=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(c);var F,G="";if((_.isNumber(i)||i&&_.isString(i))&&(i=[i]),_.isArray(i))for(F=0;F<i.length;++F){var H=i[F];(_.isNumber(H)||H&&_.isString(H))&&(H=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(H),G+=ob.REQUEST_GEOID+H)}var I="";if((_.isNumber(j)||j&&_.isString(j))&&(j=[j]),_.isArray(j))for(F=0;F<j.length;++F){var J=j[F];(_.isNumber(J)||J&&_.isString(J))&&(J=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(J),I+=ob.REQUEST_WMO+J)}var K="";if((_.isNumber(k)||k&&_.isString(k))&&(k=[k]),_.isArray(k))for(F=0;F<k.length;++F){var L=k[F];(_.isNumber(L)||L&&_.isString(L))&&(L=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(L),K+=ob.REQUEST_FMISID+L)}var M="";if(l)for(_.isString(l)&&(l=[l]),F=0;F<l.length;++F){var N=l[F];N&&_.isString(N)&&(N=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(N),M+=ob.REQUEST_PLACE+N)}var O="";m&&(O=ob.REQUEST_BBOX+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(m));var P="";n&&(P=ob.REQUEST_CRS+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(n));var Q=ob.REQUEST_STORED_QUERY_ID+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(b),R=-1===a.indexOf(ob.URL_QUERY_PREFIX_BEGIN)?ob.URL_QUERY_PREFIX_BEGIN:ob.URL_QUERY_PREFIX_AND;a.length>0&&(a.indexOf(ob.URL_QUERY_PREFIX_BEGIN)===a.length-1||a.indexOf(ob.URL_QUERY_PREFIX_AND)===a.length-1)&&(R="");var S=jb(o),T=a+R+ob.REQUEST_GET_FEATURE+Q+ob.REQUEST_PARAMETERS+c+ob.REQUEST_BEGIN+d+ob.REQUEST_END+e+D+G+I+K+M+O+P+S;gb(T,p)}function lb(a,b){var c;if(void 0!==b&&null!==b){c=new Date(b instanceof Date?b.getTime():b),c.setMilliseconds(0),c.setSeconds(0);var d=a?Math.floor(a/ob.MIN_TO_MS):void 0;if(d){var e=c.getMinutes();e-=e%d,c.setMinutes(e)}}return c}function mb(a,b,c){var d;if(void 0!==c&&null!==c&&void 0!==b&&null!==b){d=new Date(b instanceof Date?b.getTime():b);var e=lb(a,c);if(a){var f=(d.getTime()-e.getTime())%a;f>0&&d.setTime(d.getTime()+(a-f))}}return d}function nb(a){if(!a||!a.callback){var b="ERROR: Options object and callback function in it are mandatory!";throw"undefined"!=typeof console&&console&&console.error(b),b}try{kb(a.url,a.storedQueryId,a.requestParameter,a.begin,a.end,a.timestep,a.numOfTimesteps,a.denyTimeAdjusting,a.geoid,a.wmo,a.fmisid,a.sites,a.bbox,a.crs,a.queryExtension,function(b,c){ib(a.callback,b,c)})}catch(c){setTimeout(function(){"undefined"!=typeof console&&console&&console.error("ERROR: Get data error!");var b={};b[ob.KEY_ERROR_TEXT]=c.toString(),eb(a.callback,void 0,[b])},0)}}var ob={REGEX_WHITE_SPACE:/\s+/,EPOCH_TO_MS:1e3,MIN_TO_MS:6e4,HTTP_METHOD:"GET",DATA_TYPE:"xml",URL_QUERY_PREFIX_BEGIN:"?",URL_QUERY_PREFIX_AND:"&",URL_QUERY_FIELD_VALUE_DELIMITER:"=",REQUEST_GET_FEATURE:"request=getFeature",REQUEST_STORED_QUERY_ID:"&storedquery_id=",REQUEST_PARAMETERS:"&parameters=",REQUEST_BEGIN:"&starttime=",REQUEST_END:"&endtime=",REQUEST_TIMESTEP:"&timestep=",REQUEST_GEOID:"&geoid=",REQUEST_WMO:"&wmo=",REQUEST_FMISID:"&fmisid=",REQUEST_PLACE:"&place=",REQUEST_BBOX:"&bbox=",REQUEST_CRS:"&crs=",XML_WFS_FEATURE_COLLECTION:"wfs\\:FeatureCollection, FeatureCollection",XML_WFS_MEMBER:"wfs\\:member, member",XML_OMSO_POINT_TIME_SERIES_OBSERVATION:"omso\\:PointTimeSeriesObservation, PointTimeSeriesObservation",XML_OMSO_GRID_SERIES_OBSERVATION:"omso\\:GridSeriesObservation, GridSeriesObservation",XML_OM_PHENOMENON_TIME:"om\\:phenomenonTime, phenomenonTime",XML_GML_TIME_PERIOD:"gml\\:TimePeriod, TimePeriod",XML_GML_BEGIN_POSITION:"gml\\:beginPosition, beginPosition",XML_GML_END_POSITION:"gml\\:endPosition, endPosition",XML_OM_OBSERVED_PROPERTY:"om\\:observedProperty, observedProperty",XML_OM_FEATURE_OF_INTEREST:"om\\:featureOfInterest, featureOfInterest",XML_SAMS_SF_SPATIAL_SAMPLING_FEATURE:"sams\\:SF_SpatialSamplingFeature, SF_SpatialSamplingFeature",XML_SAM_SAMPLED_FEATURE:"sam\\:sampledFeature, sampledFeature",XML_TARGET_LOCATION_COLLECTION:"target\\:LocationCollection, LocationCollection",XML_TARGET_MEMBER:"target\\:member, member",XML_TARGET_LOCATION:"target\\:Location, Location",XML_GML_IDENTIFIER:"gml\\:identifier, identifier",XML_TARGET_REGION:"target\\:region, region",XML_TARGET_COUNTRY:"target\\:country, country",XML_TARGET_TIMEZONE:"target\\:timezone, timezone",XML_TARGET_REPRESENTATIVE_POINT:"target\\:representativePoint, representativePoint",XML_SAMS_SHAPE:"sams\\:shape, shape",XML_GML_MULTI_POINT:"gml\\:MultiPoint, MultiPoint",XML_GML_POINT_MEMBER:"gml\\:pointMember, pointMember",XML_GML_POINT_MEMBERS:"gml\\:pointMembers, pointMembers",XML_GML_POINT:"gml\\:Point, Point",XML_GML_NAME:"gml\\:name, name",XML_GML_POS:"gml\\:pos, pos",XML_OM_RESULT:"om\\:result, result",XML_GMLCOV_MULTI_POINT_COVERAGE:"gmlcov\\:MultiPointCoverage, MultiPointCoverage",XML_GML_DOMAIN_SET:"gml\\:domainSet, domainSet",XML_GMLCOV_SIMPLE_MULTI_POINT:"gmlcov\\:SimpleMultiPoint, SimpleMultiPoint",XML_GMLCOV_POSITIONS:"gmlcov\\:positions, positions",XML_GML_RANGE_SET:"gml\\:rangeSet, rangeSet",XML_GML_DATA_BLOCK:"gml\\:DataBlock, DataBlock",XML_GML_DOUBLE_OR_NIL_REASON_TUPLE_LIST:"gml\\:doubleOrNilReasonTupleList, doubleOrNilReasonTupleList",XML_GMLCOV_RANGE_TYPE:"gmlcov\\:rangeType, rangeType",XML_SWE_DATA_RECORD:"swe\\:DataRecord, DataRecord",XML_SWE_FIELD:"swe\\:field, field",XML_COMPOSITE_OBSERVABLE_PROPERTY:"CompositeObservableProperty",XML_COMPONENT:"component",XML_OBSERVABLE_PROPERTY:"ObservableProperty",XML_LABEL:"label",XML_BASE_PHENOMENON:"basePhenomenon",XML_UOM:"uom",XML_STATISTICAL_MEASURE:"statisticalMeasure",XML_STATISTICAL_MEASURE_INNER:"StatisticalMeasure",XML_STATISTICAL_FUNCTION:"statisticalFunction",XML_AGGREGATION_TIME_PERIOD:"aggregationTimePeriod",XML_ATTR_NAME:"name",XML_ATTR_SRS_DIMENSION:"srsDimension",XML_ATTR_XLINK_HREF:"xlink:href",XML_ATTR_GML_ID:"gml:id",XML_ATTR_CODE_SPACE:"codeSpace",XML_ATTR_CODE_SPACE_NAME:"http://xml.fmi.fi/namespace/locationcode/name",XML_ATTR_CODE_SPACE_WMO:"http://xml.fmi.fi/namespace/locationcode/wmo",XML_ATTR_CODE_SPACE_GEOID:"http://xml.fmi.fi/namespace/locationcode/geoid",XML_ATTR_CODE_SPACE_FMISID:"http://xml.fmi.fi/namespace/stationcode/fmisid",XML_ATTR_UOM:"uom",XML_REF_PREFIX:"#",XML_EXCEPTION_REPORT:"ExceptionReport",XML_EXCEPTION:"Exception",XML_ATTR_EXCEPTION_CODE:"exceptionCode",XML_EXCEPTION_TEXT:"ExceptionText",KEY_ERROR_CODE:"errorCode",KEY_ERROR_TEXT:"errorText"};return{getData:nb,adjustBeginTime:lb,adjustEndTime:mb}}(),"undefined"==typeof _||!_)throw"ERROR: Lo-dash-underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var a=function(a){var b,c=0;if(!_.isObject(a))throw"taskdef must be an object";if(!_.isString(a.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(a.location)){if(!_.isString(a.location))throw"taskDef must contain a 'location' property of either an array or a string type";b=a.location,a.location=[],a.location.push(b)}if(!_.isArray(a.parameter)){if(!_.isString(a.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";b=a.parameter,a.parameter=[],a.parameter.push(b)}if(!_.isNumber(a.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(a.resolution>.5))throw"taskDef.resolution must be a positive integer";if(a.resolution=Math.round(a.resolution),!_.isNumber(a.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(a.pointCount)){if(!(a.pointCount>0))throw"taskDef.pointCount must be greater than zero";a.end=a.start+(a.pointCount-1)*a.resolution}else{if(!_.isNumber(a.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(a.end<a.start)throw"'end' must be greater than or equal to 'start'";c=(a.end-a.start)%a.resolution,0!==c&&(a.end=a.end+(a.resolution-c)),a.pointCount=(a.end-a.start)/a.resolution+1}},b=function(a,b){var c=0;if(_.isArray(a)&&_.isArray(b)){if(a.length===b.length){for(c=0;c<a.length;c++)if(-1===_.indexOf(b,a[c]))return!1;return!0}return!1}return void 0===a||null===a||void 0===b||null===b?!1:a===b},c=function(){var b=0,c=function(c){function d(){f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=0,n=!1,o=!1,p=!1,q=[]}var e=null,f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=0,n=!1,o=!1,p=!1,q=[],r=0,s=c,t=this;this.getId=function(){return e},this.getTaskDef=function(){return i},this.getStart=function(){return null!==i?i.start:void 0},this.getEnd=function(){return null!==i?i.end:void 0},this.getPointCount=function(){return null!==i?i.pointCount:void 0},this.getResolution=function(){return null!==i?i.resolution:void 0},this.getService=function(){return null!==i?i.service:void 0},this.getLocation=function(){return null!==i?i.location:void 0},this.getParameter=function(){return null!==i?i.parameter:void 0},this.getDataSize=function(){return null!==i?i.pointCount*i.parameter.length*i.location.length:0},this.pin=function(){return n?null:(m++,s&&s("blockPinned",t),m)},this.unpin=function(){return m>0&&(m--,s&&s("blockUnpinned",t)),m},this.isPinned=function(){return m>0},this.getPinCount=function(){return m},this.getRequestId=function(){return r},this.isWaitingRecycling=function(){return n},this.isWaitingMerging=function(){return o},this.isFetched=function(){return l},this.setFetched=function(a){l=a===!0?!0:!1},this.isFetching=function(){return k},this.setFetching=function(a){k=a===!0?!0:!1},this.increaseNotUsed=function(){j++,s&&s("blockAged",t)},this.getNotUsedSince=function(){return j},this.fetchFailed=function(){return null!==f},this.markForRecycling=function(){n=!0,s&&s("blockEvicted",t)},this.markForMerging=function(a){a===!0?(o=!0,s&&s("blockMarkedForMerge",t)):(o=!1,s&&s("blockMergeCancelled",t))},this.setData=function(a){h=a},this.getFetcher=function(){return g},this.recycle=function(){d(),s&&s("blockRecycled",t)},this.prepare=function(b,c){if(!_.isFunction(c))throw"fetcher must be a function";a(b),d(),i=b,g=c,p=!0,r++,s&&s("blockPrepared",t)},this.getDataAsync=function(a){var b=this;if(!p)throw"Cannot getData in unprepared state, call prepare first";j=0,l?_.isFunction(a)&&(_.defer(function(b,c){s&&s("blockCacheFetchFinished",t),a(b,c)},f,h),s&&s("blockCacheFetchStarted",t)):(void 0!==a&&_.isFunction(a)&&q.push(a),k||(k=!0,g(i,function(a,c){var d=b.getRequestId();a&&(f=a),h=c,l=!0,0===q.length?k=!1:async.whilst(function(){var a=b.getRequestId();return d===a&&q.length>0},function(a){try{var c=q.pop();c.call(b,f,h)}catch(d){"undefined"!=typeof console&&console&&console.error("Error in block finished callback:"+d.message)}finally{a(),k=!1}},function(){}),s&&s("blockProviderFetchFinished",t)}),s&&s("blockProviderFetchStarted",t)))},e="id#"+b++,s&&s("blockCreated",t)};return c}(),d=0,e=0,f=function(f){function g(a,b){void 0!==O[a]&&_.each(O[a],function(a){try{a.call(N,b)}catch(c){}})}function h(a,b){var c=null;if(void 0===O[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(O),function(a,b,c){return c>0&&(a+=", "),a+=b});if(!_.isFunction(b))throw"Event listener callback is not a function";return c="id"+d++,O[a][c]=b,c}function i(a,b){if(void 0===O[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(O),function(a,b,c){c>0&&(a+=", "),a+=b});void 0!==O[a][b]&&delete O[a][b]}function j(a){async.each(a,function(a,b){a.markForRecycling(),b()},function(a){a&&"undefined"!=typeof console&&console&&console.error(a)})}function k(a,b,c){var d=null,e={},f=[];a.pin()>0&&b.pin()>0?(a.markForMerging(!0),b.markForMerging(!0),d=n(),e=_.clone(a.getTaskDef()),e.end=b.getEnd(),e.pointCount=a.getPointCount()+b.getPointCount(),d.prepare(e,a.getFetcher()),d.setFetching(!0),g("blockCacheFetchStarted",d),async.parallel({data1:function(b){a.getDataAsync(function(c,d){c?("undefined"!=typeof console&&console&&console.log("Warning: getDataAsync from merged block1 returned error:'"+c+"'"),b(c)):t(f,d,e.location,e.parameter,0,0,a.getPointCount(),b)})},data2:function(c){b.getDataAsync(function(d,g){d?("undefined"!=typeof console&&console&&console.log("Warning: getDataAsync from merged block2 returned error:'"+d+"'"),c(d)):t(f,g,e.location,e.parameter,a.getPointCount(),0,b.getPointCount(),c)})}},function(e){a.unpin(),b.unpin(),e?(d.reset(),a.markForMerging(!1),b.markForMerging(!1),c(e),g("blockCacheFetchFinished",null)):(a.markForRecycling(),b.markForRecycling(),d.setData(f),d.setFetching(!1),d.setFetched(!0),c(null,d),g("blockCacheFetchFinished",d))})):_.defer(function(){c(new Error("One or both blocks already marked for recycling"))})}function l(a,b){return a.getResolution()===b.getResolution()&&b.getStart()===a.getEnd()+a.getResolution()?!0:!1}function m(a,b){return!a.fetchFailed()&&!b.fetchFailed()&&!a.isWaitingMerging()&&!b.isWaitingMerging()&&(a.getPointCount()<F||b.getPointCount()<F)&&l(a,b)&&a.getPointCount()+b.getPointCount()<E?!0:!1}function n(){var a;return a=y.length>0?y.pop():new c(g)}function o(a,b,c,d){var e=!1;return a===c&&b===d?e=!0:d>=a&&b>c&&(e=!0),e}function p(a,b,c,d,e){var f=null;return(null===a||a<b-e.resolution)&&b>c&&(f=b>=d?null===a?s(e,c,d):s(e,Math.max(a,c),d):null===a?s(e,c,b-e.resolution):s(e,Math.max(a+e.resolution,c),b-e.resolution)),f}function q(a){a.isPinned()?async.whilst(function(){return a.isPinned()},function(a){setTimeout(a,500)},function(){a.recycle(),y.push(a)}):(a.recycle(),y.push(a))}function r(a){var c=[],d=a.start,e=a.end,f=Math.ceil(C*a.pointCount),h=Math.ceil(D*a.pointCount),i=d-f*a.resolution,l=e+h*a.resolution,n=[],r=[],t=-1,u=null,v=null,w=function(a){return a.getStart()};for(K=0;A.length>0;)u=A.shift(),t=_.sortedIndex(z,u,w),z.splice(t,0,u);return z.length>0&&_.each(z,function(d,e){var f=!1,g=null,h=null,j=null,t=d.getStart(),u=d.getEnd();if(d.isWaitingRecycling())return void q(d);a.service===d.getService()&&b(a.location,d.getLocation())&&b(a.parameter,d.getParameter())?(null!==v&&(j=v.getEnd()),g=p(j,t,i,l,a),null!==g&&g.length>0&&(Array.prototype.push.apply(r,g),async.reduce(g,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b}),Array.prototype.push.apply(c,g)),f=o(t,u,i,l),f?d.pin()>0?(c.push(d),L+=d.getDataSize()):"undefined"!=typeof console&&console&&console.log("Unable to pin a block, it's already marked for recycling (this should not happen)"):d.increaseNotUsed(),r.push(d),null!==v&&m(v,d)&&k(v,d,function(a,b){a?"undefined"!=typeof console&&console&&console.error(a):A.push(b)}),v=d):(d.increaseNotUsed(),r.push(d)),e===z.length-1&&null!==v&&v.getEnd()+a.resolution<l&&(h=s(a,Math.max(u+a.resolution,i),l),Array.prototype.push.apply(r,h),async.reduce(h,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b}),Array.prototype.push.apply(c,h));var w=_.sortedIndex(n,d,function(a){return a.getNotUsedSince()});n.splice(w,0,d),K+=d.getDataSize()}),0===c.length&&(c=s(a,i,l),Array.prototype.push.apply(r,c),async.reduce(c,M,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){M=b})),z=[],z=r,r=[],async.whilst(function(){return 1.01*K>G},function(){var a=1.01*K-G;g("evictStarted",{inCache:K,toEvict:a});for(var b=[],c=null,d=0;a>d&&n.length>0;)c=n.pop(),void 0!==c&&(d+=c.getDataSize(),b.push(c));b.length>0&&(j(b),K-=d,g("evictFinished",{inCache:K,evicted:d}))},function(){}),c}function s(a,b,c){var d,e=[],f=Math.round((c-b)/a.resolution)+1,g=Math.ceil(f/E),h=0,i=null;for(h=0;g>h;h++)i=n(),d=_.clone(a),d.start=b+h*a.resolution*E,d.pointCount=Math.min(E,f-h*E),d.end=d.start+(d.pointCount-1)*a.resolution,i.prepare(d,w(a.service)),i.pin()>0?e.push(i):"undefined"!=typeof console&&console&&console.error("Strange, unable to pin block!");return e}function t(a,b,c,d,e,f,g,h){var i=_.isObject(b),j=0,k=0,l=0;
async.each(c,function(c,h){void 0===a[c]&&(a[c]={}),async.each(d,function(d,h){var m=!1;if(void 0===a[c][d]&&(a[c][d]=[]),i&&(_.isObject(b[c])&&_.isArray(b[c][d])?b[c][d].length<f+g&&(m=!0,"undefined"!=typeof console&&console&&console.error("Trying to fill segment with only "+b[c][d].length+" values for location "+c+" and parameter "+d+" when "+(f+g)+" would be needed. Filling the whole segment with '"+I+"'")):m=!0),m)for(j=e,l=e+g;l>j;)a[c][d][j++]=I;else if(i)for(j=e,k=f,l=e+g;l>j;)a[c][d][j++]=b[c][d][k++];else for(j=e,l=e+g;l>j;)a[c][d][j++]=b;h()},function(){h()})},function(b){h(b,a)})}function u(a,b,c){var d=_.clone(a);if(!_.isFunction(b))throw"finishCallback must be a function";if(null===w(d.service))throw"No data fetcher set for service '"+d.service+"', unable to provide data";void 0!==B[d.service]&&(B[d.service].resolution!==d.resolution||Math.abs(B[d.service].start-d.start)%d.resolution!==0)&&x(d.service),B[d.service]={start:d.start,resolution:d.resolution},P.push(d,function(a,e){v(e,d,b,c)})}function v(a,b,c,d){var e=null,f=!1,h={};_.isFunction(d)&&(f=!0),g("fetchStarted",b),h.steps=_.range(b.start,b.end+b.resolution,b.resolution),h.data={},async.each(a,function(a,c){var g=a.getTaskDef(),i=0/0,j=0/0,k=0/0,l=0/0,m=0/0,n=0/0;if(!o(g.start,g.end,b.start,b.end))return a.getDataAsync(function(){a.unpin()}),void c();if(g.start<b.start?(i=b.start,m=Math.round((b.start-g.start)/b.resolution)):(i=g.start,m=0),k=_.indexOf(h.steps,i,!0),-1===k)throw a.getId()+":something wrong with indexing, start index for cache block not found in the combined results!";g.end>b.end?(j=b.end,l=h.steps.length-1):(j=g.end,l=_.indexOf(h.steps,g.end,!0)),n=l-k+1,a.getDataAsync(function(b,l){var o=l;b&&(null===e&&(e=[]),e.push({start:g.start,end:g.end,error:b}),(H||!l)&&(o=I),a.markForRecycling()),t(h.data,o,g.location,g.parameter,k,m,n,function(){f&&d(b,i,j),a.unpin(),c()})})},function(){c(e,h),g("fetchFinished",b)})}function w(a){return void 0!==J[a]?(J[a].nextIndex=(J[a].nextIndex+1)%J[a].providers.length,J[a].providers[J[a].nextIndex].cb):null}function x(a){_.each(z,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),_.each(A,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),g("cacheCleared",a)}var y=[],z=[],A=[],B=[],C=.5,D=1,E=500,F=20,G=5e4,H=!0,I=0/0,J={},K=0,L=0,M=0,N=this,O={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},blockMarkedForMerge:{},blockMergeCancelled:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}},P=async.queue(function(a,b){b(null,r(a))},1);this.addDataProvider=function(a,b){var c={};if(!_.isFunction(b))throw"Fetcher must be a function";return void 0===J[a]&&(J[a]={nextIndex:0,providers:[]}),c.id="id#"+e++,c.cb=b,J[a].providers.push(c),g("dataProviderAdded",{service:a,providerId:c.id}),c.id},this.removeDataProvider=function(a,b){var c=0,d=!1;void 0!==J[a]&&(c=J[a].providers.length,J[a].providers=_.reject(J[a].providers,function(a){return a.id===b}),0===J[a].providers.length?(delete J.service,d=!0):c!==J[a].providers.length&&(d=!0),d&&g("dataProviderRemoved",{service:a,providerId:b}))},this.clearCache=function(){x(),B=[],L=0,M=0},this.fetch=function(b,c,d){a(b),u(b,c,d)},this.getCachedItemCount=function(){return K},this.getFillingDegree=function(){return K/G},this.getHitRatio=function(){return L/(L+M)},this.addListener=function(a,b){return h(a,b)},this.removeListener=function(a,b){return i(a,b)},void 0!==f.sideFetchBeforeFactor&&_.isNumber(f.sideFetchBeforeFactor)&&f.sideFetchBeforeFactor>=0&&(C=f.sideFetchBeforeFactor),void 0!==f.sideFetchAfterFactor&&_.isNumber(f.sideFetchAfterFactor)&&f.sideFetchAfterFactor>=0&&(D=f.sideFetchAfterFactor),void 0!==f.maxBlockDataPoints&&_.isNumber(f.maxBlockDataPoints)&&f.maxBlockDataPoints>0&&(E=f.maxBlockDataPoints),void 0!==f.minBlockDataPoints&&_.isNumber(f.minBlockDataPoints)&&(F=f.minBlockDataPoints>0&&f.minBlockDataPoints<E?f.minBlockDataPoints:0),F>E&&(F=E),void 0!==f.maxCacheDataSize&&_.isNumber(f.maxCacheDataSize)&&f.maxCacheDataSize>0&&(G=f.maxCacheDataSize),void 0!==f.strictErrorHandling&&f.strictErrorHandling===!1&&(H=!1),void 0!==f.errorFillValue&&(I=f.errorFillValue)};return f}(),"undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof _||!_)throw"ERROR: Lodash is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.WfsConnection!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.SplitterCache)throw"ERROR: fi.fmi.metoclient.metolib.SplitterCache is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.WfsRequestParser)throw"ERROR: fi.fmi.metoclient.metolib.WfsRequestParser is required for fi.fmi.metoclient.metolib.WfsConnection!";fi.fmi.metoclient.metolib.WfsConnection=function(){function a(a){return jQuery.trim(a).replace(/,\s+/,m)}function b(b,c){var d=[];if(_.isString(c)||(c=""),b&&_.isString(b))d.push(c+a(b));else if(_.isArray(b))for(var e=0;e<b.length;++e){var f=b[e];f&&_.isString(f)&&d.push(c+a(f))}return d}function c(a,b){var c=[];if(_.isString(b)||(b=""),_.isNumber(a)||a&&_.isString(a))c.push(jQuery.trim(b+a));else if(_.isArray(a))for(var d=0;d<a.length;++d){var e=a[d];(_.isNumber(e)||e&&_.isString(e))&&c.push(jQuery.trim(b+e))}return c}function d(a,d){if(a&&d){var e=[];a.location=e,a.geoid=c(d.geoid),a.wmo=c(d.wmo),a.fmisid=c(d.fmisid),a.sites=b(d.sites),e.push.apply(e,c(d.geoid,o)),e.push.apply(e,c(d.wmo,p)),e.push.apply(e,c(d.fmisid,q)),e.push.apply(e,b(d.sites,r))}}function e(a,b,c,d,e,f){var g=r+c;if(a){var h,i,j=!1;if(a.geoid&&e)for(i=0;i<a.geoid.length;++i)if(a.geoid[i]===e){g=o+e,j=!0;break}if(!j&&a.wmo&&d)for(i=0;i<a.wmo.length;++i)if(a.wmo[i]===d){g=p+d,j=!0;break}if(!j&&a.fmisid&&f)for(i=0;i<a.fmisid.length;++i)if(a.fmisid[i]===f){g=q+f,j=!0;break}if(!j&&a.sites&&c){if(b){var k=c+n,l=b.indexOf(k);0===l&&(b=jQuery.trim(b.slice(k.length)));var s=(b+m+c).toLowerCase();for(i=0;i<a.sites.length;++i)if(h=a.sites[i],h&&s&&h.toLowerCase()===s){g=r+h,j=!0;break}}if(!j){var t=c.toLowerCase();for(i=0;i<a.sites.length;++i)if(h=a.sites[i],h&&h.toLowerCase()===t){g=r+h,j=!0;break}}}}return g}function f(a,b){if(_.isArray(a)&&b&&b>0)for(var c=1;c<a.length;++c){var d=a[c-1],e=a[c];if(_.isObject(e)){var f=_.isObject(d)?d.time:void 0,g=e.time;void 0!==f&&null!==f&&void 0!==g&&null!==g&&g-f>b&&(g=f+b,a.splice(c,0,{time:g,value:0/0})),f=g}}}function g(a,b){return _.find(a,function(a){return _.isEqual(a,b)})}function h(a){var b=[];if(_.isArray(a))for(var c=0;c<a.length;++c){var d=a[c],e=_.isObject(d)&&(d.errorCode||d.errorText);if(_.isObject(d)&&_.isArray(d.error)&&d.error.length>0)for(var f=d.error,h=0;h<f.length;++h){var i=f[h];if(_.isObject(i)&&(i.errorCode||i.errorText)){var j={errorCode:i.errorCode,errorText:i.errorText,extension:d};g(b,j)||b.push(j)}else e=!0}else e=!0;if(e){var k={errorCode:_.isObject(d)?d.errorCode:void 0,errorText:_.isObject(d)&&_.isString(d.errorText)?d.errorText:s,extension:d};g(b,k)||b.push(k)}}return b}function i(a,b,c){var d={data:b?{}:void 0,errors:c&&!c.length?null:c};return b&&_.each(b.locations,function(c){var g=e(a,c.info.name,c.info.region,c.info.wmo,c.info.geoid,c.info.fmisid);d.data[g]||(d.data[g]={}),_.each(c.data,function(e,h){d.data[g][h]||(d.data[g][h]=[]),f(e.timeValuePairs,a.resolution),_.each(e.timeValuePairs,function(a){var f={info:b.info,properties:b.properties,locationInfo:c.info,blockProperty:e.property,timeValuePair:a};d.data[g][h].push(f)})})}),d}function j(a,b,c){var d={data:b?{info:void 0,properties:void 0,locations:[]}:void 0,errors:h(c)};return b&&_.each(b.data,function(a){var b={info:void 0,data:{}};_.each(a,function(a,c){var e={property:void 0,timeValuePairs:[]};_.each(a,function(a){a&&(d.data.info||(d.data.info=a.info),d.data.properties||(d.data.properties=a.properties),e.property||(e.property=a.blockProperty),b.info||(b.info=a.locationInfo),e.timeValuePairs.push(a.timeValuePair))}),b.data[c]=e}),d.data.locations.push(b)}),d}function k(a,b,c){fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:a.connectionUrl,storedQueryId:a.storedQueryId,requestParameter:b.parameter,begin:b.start,end:b.end,timestep:b.resolution,denyTimeAdjusting:!0,geoid:b.geoid,wmo:b.wmo,fmisid:b.fmisid,sites:b.sites,crs:b.crs,queryExtension:b.queryExtension,callback:function(d,e){var f=i.call(a,b,d,e);c(f.errors,f.data)}})}var l="parserSites",m=",",n=" ",o="g_",p="w_",q="f_",r="s_",s="ERROR: Cache found error(s)!",t=function(a){if(a.timestep&&1!==a.timestep){var e=a.begin,f=a.end,g=a.timestep;a.denyTimeAdjusting||(e=fi.fmi.metoclient.metolib.WfsRequestParser.adjustBeginTime(g,e),f=fi.fmi.metoclient.metolib.WfsRequestParser.adjustEndTime(g,f,e));var h={service:l,parameter:_.isString(a.requestParameter)?a.requestParameter.split(m):a.requestParameter,start:e instanceof Date?e.getTime():e,end:f instanceof Date?f.getTime():f,resolution:g,crs:a.crs,queryExtension:a.queryExtension};d(h,a),this.cache.fetch(h,function(b,c){var d=j(h,c,b);a.callback(d.data,d.errors)},a.progressCallback)}else{var i=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:i.connectionUrl,storedQueryId:i.storedQueryId,requestParameter:a.requestParameter,begin:a.begin,end:a.end,timestep:a.timestep,denyTimeAdjusting:a.denyTimeAdjusting,geoid:c(a.geoid),wmo:c(a.wmo),fmisid:c(a.fmisid),sites:b(a.sites),crs:a.crs,queryExtension:a.queryExtension,callback:a.callback})}},u=function(a){var d=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:d.connectionUrl,storedQueryId:d.storedQueryId,requestParameter:a.requestParameter,begin:a.begin,end:a.end,timestep:a.timestep,denyTimeAdjusting:a.denyTimeAdjusting,geoid:c(a.geoid),wmo:c(a.wmo),fmisid:c(a.fmisid),sites:b(a.sites),bbox:a.bbox,crs:a.crs,queryExtension:a.queryExtension,callback:a.callback})},v=function(a,b){var c=!0;try{var d=Array.prototype.slice.call(arguments);d.shift(),d.shift(),a.apply(this,d)}catch(e){var f="ERROR: API level error occurred in a synchronous flow!";if("undefined"!=typeof console&&console&&console.error(f),c=!1,b){var g={errorText:f};b(void 0,g)}}return c},w=function(){return this.connectionUrl},x=function(){return this.storedQueryId},y=function(a,b){if(!this.connectionUrl){if(!_.isString(a)||!a){var c="ERROR: WfsConnection URL must be a string and not empty!";throw"undefined"!=typeof console&&console&&console.error(c),c}if(!_.isString(b)||!b){var d="ERROR: WfsConnection stored query ID must be a string and not empty!";throw"undefined"!=typeof console&&console&&console.error(d),d}this.connectionUrl=a,this.storedQueryId=b}},z=function(){this.connectionUrl=void 0,this.storedQueryId=void 0,A.call(this)},A=function(){this.cache.clearCache()},B=function(a){if(!a){var b="ERROR: Options object is mandatory!";throw"undefined"!=typeof console&&console&&console.error(b),b}if(a.bbox)u.call(this,a);else{if(!(a.geoid||a.wmo||a.fmisid||a.sites)){var c="ERROR: Either geoid, wmo, fmisid, sites or bbox is mandatory in options!";throw"undefined"!=typeof console&&console&&console.error(c),c}t.call(this,a)}},C=function(){var a=this,b={connectionInstance:a,connectionUrl:void 0,storedQueryId:void 0,cache:new fi.fmi.metoclient.metolib.SplitterCache({sideFetchAfterFactor:1,sideFetchBeforeFactor:.5,maxBlockDataPoints:200,maxCacheDataSize:4e3})};b.cache.addDataProvider(l,function(a,c){k(b,a,c)}),this.getUrl=function(){return w.call(b)},this.getStoredQueryId=function(){return x.call(b)},this.connect=function(a,c){return v.call(b,y,void 0,a,c)},this.disconnect=function(){return v.call(b,z,void 0)},this.resetCache=function(){return v.call(b,A,void 0)},this.getData=function(a){return v.call(b,B,a?a.callback:void 0,a)}};return C}();